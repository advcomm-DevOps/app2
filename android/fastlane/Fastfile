  # Fastfile for XDoc Android

  default_platform(:android)

  platform :android do
    # Before all lanes
    before_all do
      # Ensure we're in the android directory
      Dir.chdir("../..") do
        # Get Flutter dependencies
        sh("flutter pub get")
      end
    end

    # Internal testing lane (for internal testers)
    desc "Deploy a new version to Google Play Internal Testing"
    lane :internal do
      # Build the app bundle (version comes from pubspec.yaml)
      Dir.chdir("../..") do
        sh("flutter build appbundle --release")
      end

      # Upload to Play Store (Internal track)
      json_key_file = ENV["PLAY_STORE_JSON_KEY_PATH"] || "service_account.json"
      upload_to_play_store(
        track: 'internal',
        aab: '../build/app/outputs/bundle/release/app-release.aab',
        json_key: json_key_file,
        skip_upload_metadata: false,
        release_status: 'draft',
        skip_upload_changelogs: false,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )

      # Success message
      UI.success("Successfully deployed to Internal Testing! ðŸŽ‰")
    end

    # Beta testing lane (closed testing)
    desc "Deploy a new version to Google Play Beta (Closed Testing)"
    lane :beta do
      # Build the app bundle (version comes from pubspec.yaml)
      Dir.chdir("../..") do
        sh("flutter build appbundle --release")
      end

      # Upload to Play Store (Beta track)
      json_key_file = ENV["PLAY_STORE_JSON_KEY_PATH"] || "service_account.json"
      upload_to_play_store(
        track: 'beta',
        aab: '../build/app/outputs/bundle/release/app-release.aab',
        json_key: json_key_file,
        release_status: 'draft',
        skip_upload_metadata: false,
        skip_upload_changelogs: false,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )

      # Success message
      UI.success("Successfully deployed to Beta Testing! ðŸŽ‰")
    end

    # Production release lane
    desc "Deploy a new version to Google Play Production"
    lane :production do
      # Build the app bundle (version comes from pubspec.yaml)
      Dir.chdir("../..") do
        sh("flutter build appbundle --release")
      end

      # Upload to Play Store (Production track)
      json_key_file = ENV["PLAY_STORE_JSON_KEY_PATH"] || "service_account.json"
      upload_to_play_store(
        track: 'production',
        aab: '../build/app/outputs/bundle/release/app-release.aab',
        json_key: json_key_file,
        release_status: 'draft',
        skip_upload_metadata: false,
        skip_upload_changelogs: false,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        rollout: '0.1'  # Start with 10% rollout
      )

      # Success message
      UI.success("Successfully deployed to Production (10% rollout)! ðŸŽ‰")
    end

    # Promote beta to production
    desc "Promote Beta to Production"
    lane :promote_to_production do
      json_key_file = ENV["PLAY_STORE_JSON_KEY_PATH"] || "service_account.json"
      upload_to_play_store(
        track: 'beta',
        track_promote_to: 'production',
        json_key: json_key_file,
        release_status: 'draft',
        skip_upload_metadata: true,
        skip_upload_changelogs: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        rollout: '0.1'  # Start with 10% rollout
      )

      UI.success("Successfully promoted Beta to Production! ðŸŽ‰")
    end

    # Build APK for testing
    desc "Build APK for direct installation"
    lane :build_apk do
      Dir.chdir("../..") do
        sh("flutter build apk --release")
      end

      UI.success("APK built successfully! ðŸ“¦")
      UI.message("APK location: build/app/outputs/flutter-apk/app-release.apk")
    end

    # Generate screenshots (future enhancement)
    desc "Generate screenshots for Play Store"
    lane :screenshots do
      # TODO: Set up screengrab for automated screenshots
      UI.message("Screenshots generation not yet configured")
      UI.message("Add screengrab configuration to enable this feature")
    end

    # After all lanes
    after_all do |lane|
      # Clean up
      UI.success("Lane #{lane} completed successfully! âœ…")
    end

    # Error handler
    error do |lane, exception|
      UI.error("Error in lane #{lane}: #{exception.message}")
    end
  end