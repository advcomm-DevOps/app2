name: Android - Fastlane Deploy

on:
  push:
    tags:
      - 'v*'  # Only trigger on version tags like v1.0.1, v1.0.2, etc.
  workflow_dispatch:  # Allow manual triggering from GitHub Actions UI

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.35.7'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag detection

      - name: Get version tag
        id: version_tag
        run: |
          tag=$(git describe --tags --exact-match 2>/dev/null || echo "")
          if [ -n "$tag" ]; then
            echo "VERSION_TAG=$tag" >> $GITHUB_OUTPUT
            echo "Found version tag: $tag"
          else
            echo "No version tag found"
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Set up Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: './android'

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true

      - name: Run Flutter tests
        run: flutter test
        continue-on-error: true

      - name: Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF

      - name: Create Play Store service account JSON
        run: |
          mkdir -p android
          echo '${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON_BASE64 }}' | tr -d '\n\r ' | base64 --decode > android/service_account.json

      - name: Validate Play Store JSON
        run: |
          python -m json.tool android/service_account.json >/dev/null || {
            echo "Error: Invalid JSON in service account file"
            exit 1
          }
          echo "JSON validation successful"

      - name: Install Fastlane dependencies
        working-directory: android
        run: |
          bundle install
          bundle exec fastlane --version

      - name: Deploy to Internal Testing
        working-directory: android
        env:
          PLAY_STORE_JSON_KEY_PATH: service_account.json
        run: |
          echo "ðŸš€ Deploying to Internal Testing track..."
          echo "ðŸ“ Using version from pubspec.yaml (no auto-increment)"
          if [ -n "${{ steps.version_tag.outputs.VERSION_TAG }}" ]; then
            echo "Version tag: ${{ steps.version_tag.outputs.VERSION_TAG }}"
          fi
          bundle exec fastlane internal

      - name: Build APK for artifacts
        working-directory: android
        run: bundle exec fastlane build_apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab-${{ github.run_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Build Summary
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')

          echo "## ðŸŽ‰ Android Build & Deploy Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.version_tag.outputs.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${CURRENT_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Deployed to **Google Play Internal Track**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Available to internal testers!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Version from pubspec.yaml (manual versioning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- AAB (Play Store): \`app-release.aab\`" >> $GITHUB_STEP_SUMMARY
          echo "- APK (Direct Install): \`app-release.apk\`" >> $GITHUB_STEP_SUMMARY

      - name: Clean up
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
          rm -f android/service_account.json