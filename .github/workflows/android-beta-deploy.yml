name: Android - Fastlane Deploy

on:
  push:
    branches: [main, master, 'feature/android-fastlane']
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.35.7'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag detection

      - name: Check if commit has version tag
        id: check_tag
        run: |
          tag=$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          if [ -n "$tag" ]; then
            echo "HAS_VERSION_TAG=true" >> $GITHUB_OUTPUT
            echo "VERSION_TAG=$tag" >> $GITHUB_OUTPUT
            echo "Found version tag: $tag"
          else
            echo "HAS_VERSION_TAG=false" >> $GITHUB_OUTPUT
            echo "No version tag found on this commit"
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Set up Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: './android'

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true

      - name: Run Flutter tests
        run: flutter test
        continue-on-error: true

      - name: Decode Android keystore
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF

      - name: Create Play Store service account JSON
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p android
          echo '${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON_BASE64 }}' | tr -d '\n\r ' | base64 --decode > android/service_account.json

      - name: Validate Play Store JSON
        if: github.event_name != 'pull_request'
        run: |
          python -m json.tool android/service_account.json >/dev/null || {
            echo "Error: Invalid JSON in service account file"
            exit 1
          }
          echo "JSON validation successful"

      - name: Install Fastlane dependencies
        if: github.event_name != 'pull_request'
        working-directory: android
        run: |
          bundle install
          bundle exec fastlane --version

      - name: Deploy to Internal Testing (no tag)
        if: github.event_name != 'pull_request' && steps.check_tag.outputs.HAS_VERSION_TAG == 'false' && (github.ref_name == 'main' || github.ref_name == 'master' || startsWith(github.ref_name, 'feature/android'))
        working-directory: android
        env:
          PLAY_STORE_JSON_KEY_PATH: service_account.json
        run: |
          echo "ðŸš€ Deploying to Internal Testing track..."
          echo "ðŸ“ Fastlane will auto-increment version code"
          bundle exec fastlane internal

      - name: Deploy to Beta Testing (with tag)
        if: github.event_name != 'pull_request' && steps.check_tag.outputs.HAS_VERSION_TAG == 'true'
        working-directory: android
        env:
          PLAY_STORE_JSON_KEY_PATH: service_account.json
        run: |
          echo "ðŸš€ Deploying to Beta Testing track (version: ${{ steps.check_tag.outputs.VERSION_TAG }})..."
          echo "ðŸ“ Fastlane will auto-increment version code"
          bundle exec fastlane beta

      - name: Build APK for artifacts
        if: github.event_name != 'pull_request'
        working-directory: android
        run: bundle exec fastlane build_apk

      - name: Upload APK artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload AAB artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab-${{ github.run_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Build Summary
        if: github.event_name != 'pull_request'
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')

          echo "## ðŸŽ‰ Android Build & Deploy Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${CURRENT_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_tag.outputs.HAS_VERSION_TAG }}" == "true" ]; then
            echo "### ðŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
            echo "Deployed to **Google Play Beta Track** (Closed Testing)" >> $GITHUB_STEP_SUMMARY
            echo "Tag: \`${{ steps.check_tag.outputs.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Version code auto-incremented by Fastlane" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ”§ Deployment" >> $GITHUB_STEP_SUMMARY
            echo "Deployed to **Google Play Internal Track**" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Available to 3 internal testers instantly!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Version code auto-incremented by Fastlane" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- AAB (Play Store): \`app-release.aab\`" >> $GITHUB_STEP_SUMMARY
          echo "- APK (Direct Install): \`app-release.apk\`" >> $GITHUB_STEP_SUMMARY

      - name: Clean up
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
          rm -f android/service_account.json
