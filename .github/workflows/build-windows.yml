name: Build Windows App

on:
  push:
    branches: [main, master, 'feature/windows-build']
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags

      - name: Check if commit has version tag
        id: check_tag
        shell: pwsh
        run: |
          $tag = git tag --points-at HEAD | Where-Object { $_ -match '^v\d+\.\d+\.\d+' } | Select-Object -First 1
          if ($tag) {
            echo "HAS_VERSION_TAG=true" >> $env:GITHUB_OUTPUT
            echo "VERSION_TAG=$tag" >> $env:GITHUB_OUTPUT
            Write-Host "Found version tag: $tag"
          } else {
            echo "HAS_VERSION_TAG=false" >> $env:GITHUB_OUTPUT
            Write-Host "No version tag found on this commit"
          }

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: stable

      - name: Install NuGet
        run: |
          mkdir C:\nuget -Force
          Invoke-WebRequest -Uri https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile C:\nuget\nuget.exe
          echo "C:\nuget" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Auto-sync MSIX version and identity
        shell: pwsh
        run: |
          $pubspecContent = Get-Content pubspec.yaml -Raw

          # Check if commit has a version tag
          $hasVersionTag = "${{ steps.check_tag.outputs.HAS_VERSION_TAG }}" -eq "true"

          if ($hasVersionTag) {
            # Extract version from detected tag
            $tagName = "${{ steps.check_tag.outputs.VERSION_TAG }}"
            $versionFromTag = $tagName -replace '^v', '' -replace '-.*$', ''

            Write-Host "=== TAG PUSH DETECTED ==="
            Write-Host "Tag name: $tagName"
            Write-Host "Extracted version: $versionFromTag"

            # Determine build number (default to 0 for new versions)
            $buildNumber = "0"

            # Update pubspec.yaml version
            $pubspecContent = $pubspecContent -replace 'version:\s*[0-9.]+\+?[0-9]*', "version: $versionFromTag+$buildNumber"

            $flutterVersion = "$versionFromTag+$buildNumber"
            $msixVersion = "$versionFromTag.$buildNumber"

            Write-Host "Auto-updated Flutter version: $flutterVersion"
            Write-Host "MSIX version (converted): $msixVersion"
          } else {
            # Extract version from existing pubspec.yaml (for non-tag builds)
            $versionMatch = [regex]::Match($pubspecContent, 'version:\s*([0-9.]+)\+([0-9]+)')

            if ($versionMatch.Success) {
              $versionPart = $versionMatch.Groups[1].Value
              $buildNumber = $versionMatch.Groups[2].Value
              $flutterVersion = "$versionPart+$buildNumber"
              $msixVersion = "$versionPart.$buildNumber"

              Write-Host "=== BRANCH BUILD ==="
              Write-Host "Flutter version from pubspec: $flutterVersion"
              Write-Host "MSIX version (converted): $msixVersion"
            } else {
              Write-Host "ERROR: Could not extract version from pubspec.yaml"
              Write-Host "Expected format: version: 1.0.0+8"
              exit 1
            }
          }

          # Replace msix_version with version (msix package expects 'version' not 'msix_version')
          $pubspecContent = $pubspecContent -replace 'msix_version:\s*[0-9.]+' , "version: $msixVersion"

          # Update identity_name to app.xdoc.test
          $pubspecContent = $pubspecContent -replace 'identity_name:\s*com\.xdocapp\.test', 'identity_name: app.xdoc.test'

          # Save updated pubspec.yaml
          Set-Content -Path pubspec.yaml -Value $pubspecContent

          Write-Host "✓ Replaced msix_version with version: $msixVersion"
          Write-Host "✓ Updated identity_name to: app.xdoc.test"

          # Export version for later steps
          echo "APP_VERSION=$flutterVersion" >> $env:GITHUB_ENV
          echo "MSIX_VERSION=$msixVersion" >> $env:GITHUB_ENV

      - name: Run tests
        run: flutter test
        continue-on-error: true

      - name: Build Windows app
        run: flutter build windows --release

      - name: Create MSIX installer
        run: dart run msix:create

      - name: Create build info
        run: |
          echo "Build completed at: $(Get-Date)" > build/windows/x64/runner/Release/build-info.txt
          echo "App: XDoc" >> build/windows/x64/runner/Release/build-info.txt
          echo "Version: ${{ env.APP_VERSION }}" >> build/windows/x64/runner/Release/build-info.txt
          echo "MSIX Version: ${{ env.MSIX_VERSION }}" >> build/windows/x64/runner/Release/build-info.txt
          echo "Commit: ${{ github.sha }}" >> build/windows/x64/runner/Release/build-info.txt

      - name: Upload Windows executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: xdoc-windows-exe-${{ github.run_number }}
          path: build/windows/x64/runner/Release/
          retention-days: 30

      - name: Upload MSIX installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: xdoc-windows-msix-${{ github.run_number }}
          path: build/windows/x64/runner/Release/xdoc.msix
          retention-days: 30

      - name: Upload to Hetzner Object Storage
        if: steps.check_tag.outputs.HAS_VERSION_TAG == 'true'
        shell: pwsh
        run: |
          # Install AWS CLI
          choco install awscli -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" +
          [System.Environment]::GetEnvironmentVariable("Path","User")

          # Configure AWS CLI for Hetzner Object Storage
          aws configure set aws_access_key_id ${{ secrets.S3_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.S3_SECRET_ACCESS_KEY }}
          aws configure set default.region us-east-1

          # Upload files to S3 bucket with public-read ACL
          aws s3 cp build/windows/x64/runner/Release/xdoc.msix s3://${{ secrets.S3_BUCKET_NAME }}/windows/xdoc-latest.msix --endpoint-url ${{ secrets.S3_ENDPOINT }} --acl public-read
          aws s3 cp build/windows/x64/runner/Release/xdoc.msix s3://${{ secrets.S3_BUCKET_NAME }}/windows/xdoc-${{ steps.check_tag.outputs.VERSION_TAG }}.msix --endpoint-url ${{ secrets.S3_ENDPOINT }} --acl public-read

      - name: Create GitHub Release
        if: steps.check_tag.outputs.HAS_VERSION_TAG == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.check_tag.outputs.VERSION_TAG }}
          body: |
            ## Download XDoc for Windows

            **Direct Download:**
            https://downloads.xdoc.app/windows/xdoc-${{ steps.check_tag.outputs.VERSION_TAG }}.msix

            **Always Latest Version:**
            https://downloads.xdoc.app/windows/xdoc-latest.msix

            ## Installation
            1. Download the .msix file
            2. Double-click to install
            3. Launch XDoc from Start Menu

            ---
            **Version:** ${{ env.APP_VERSION }}
            **MSIX Version:** ${{ env.MSIX_VERSION }}
            **Build:** ${{ github.run_number }}
          draft: false
          prerelease: false
